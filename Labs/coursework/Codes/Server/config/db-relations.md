# Отношения и зависимости в БД #

## Создание ##

**1. SQL-скрипт для создания таблиц:**

```sql
-- Создание таблицы фильмов
CREATE TABLE movies (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    release_year INTEGER NOT NULL,
    description TEXT
);

-- Создание таблицы жанров
CREATE TABLE genres (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL
);

-- Связующая таблица фильм-жанр
CREATE TABLE movie_genres (
    movie_id INTEGER REFERENCES movies(id) ON DELETE CASCADE,
    genre_id INTEGER REFERENCES genres(id) ON DELETE CASCADE,
    PRIMARY KEY (movie_id, genre_id)
);

-- Таблица рейтингов
CREATE TABLE ratings (
    id SERIAL PRIMARY KEY,
    movie_id INTEGER REFERENCES movies(id) ON DELETE CASCADE,
    rating DECIMAL(3,1) NOT NULL CHECK (rating BETWEEN 0 AND 10),
    created_at TIMESTAMP DEFAULT NOW()
);

-- Оптимизационные индексы
CREATE INDEX idx_movies_title ON movies (title text_pattern_ops);
CREATE INDEX idx_movies_year ON movies (release_year);
CREATE INDEX idx_movie_genres ON movie_genres (genre_id);
CREATE INDEX idx_ratings_movie ON ratings (movie_id);
```

**2. Пример заполнения тестовыми данными:**

```sql
-- Добавляем основные жанры
INSERT INTO genres (name) VALUES
('Драма'),
('Комедия'),
('Фантастика'),
('Боевик'),
('Триллер'),
('Мелодрама'),
('Приключения'),
('Ужасы'),
('Документальный'),
('Анимация'),
('Музыкальный'),
('Исторический'),
('Фэнтези'),
('Семейный'),
('Спорт'),
('Криминал'),
('Романтика'),
('Научная фантастика'),
('Супергеройский'),
('Психологический триллер'),
('Военный');


-- Добавляем фильмы
INSERT INTO movies (title, release_year, description) VALUES
('Крепкий орешек', 1988, 'Полицейский против террористов в небоскребе'),
('Интерстеллар', 2014, 'Космическая эпопея о путешествии сквозь червоточину'),
('Матрица', 1999, 'Боевик о войне человечества с машинами');

-- Связываем фильмы с жанрами
INSERT INTO movie_genres (movie_id, genre_id) VALUES
(1, 1), -- Миссия невыполнима: Последствия - Драма
(1, 4), -- Миссия невыполнима: Последствия - Боевик
(2, 3), -- Человек-паук: Через вселенные - Фантастика
(2, 2), -- Человек-паук: Через вселенные - Комедия
(3, 4), -- Топ Ган: Маверик - Боевик
(3, 1), -- Топ Ган: Маверик - Драма
(4, 1), -- Джек Ричер - Драма
(5, 2), -- test - Комедия
(6, 3), -- Чудо-женщина 1984 - Фантастика
(6, 1), -- Чудо-женщина 1984 - Драма
(7, 2), -- Барби - Комедия
(7, 3), -- Барби - Фантастика
(8, 1), -- Опенгеймер - Драма
(8, 4), -- Опенгеймер - Триллер
(9, 1), -- Дюна - Драма
(9, 17); -- Дюна - Научная фантастика

-- Добавляем рейтинги
INSERT INTO ratings (movie_id, rating) VALUES
(1, 7.8),  -- Миссия невыполнима: Последствия
(1, 8.0),
(1, 7.9),
(2, 8.4),  -- Человек-паук: Через вселенные
(2, 8.5),
(2, 8.7),
(3, 8.3),  -- Топ Ган: Маверик
(3, 8.5),
(3, 8.6),
(4, 7.0),  -- Джек Ричер
(4, 7.5),
(4, 6.8),
(5, 6.0),  -- test
(5, 6.3),
(5, 6.5),
(6, 7.5),  -- Чудо-женщина 1984
(6, 6.8),
(6, 7.0),
(7, 7.9),  -- Барби
(7, 8.0),
(7, 8.2),
(8, 8.4),  -- Опенгеймер
(8, 8.5),
(8, 8.3),
(9, 8.2),  -- Дюна
(9, 8.1),
(9, 8.4);

```

**3. Настройки PostgreSQL для оптимизации:**

```sql
-- Настройка рабочей памяти для сортировок
SET work_mem = '64MB';

-- Оптимизация для LIKE-запросов
SET pg_trgm.similarity_threshold = 0.3;
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Оптимизация для полнотекстового поиска (дополнительно)
ALTER TABLE movies ADD COLUMN search_vector tsvector;
UPDATE movies SET search_vector = to_tsvector('english', title || ' ' || description);
CREATE INDEX idx_movies_search ON movies USING GIN(search_vector);
```

**4. Требования к окружению:**
- PostgreSQL 12+
- Работающее расширение pg_trgm
- Права на чтение/запись для пользователя БД
- Локаль БД: UTF-8

**5. Проверка работоспособности:**

Пример запроса для проверки поиска:
```sql
SELECT 
  m.title,
  m.release_year,
  AVG(r.rating) as avg_rating,
  STRING_AGG(g.name, ', ') AS genres
FROM movies m
LEFT JOIN ratings r ON m.id = r.movie_id
LEFT JOIN movie_genres mg ON m.id = mg.movie_id
LEFT JOIN genres g ON mg.genre_id = g.id
WHERE m.title ILIKE '%матриц%'
  AND g.name = 'Фантастика'
  AND m.release_year BETWEEN 1990 AND 2000
GROUP BY m.id
ORDER BY m.title;
```

Данная структура обеспечит:
- Быстрый поиск по названию фильма
- Эффективную фильтрацию по жанрам и годам
- Корректный расчет рейтингов
- Оптимальную работу автодополнения
- Масштабируемость на большие объемы данных


## Итог ##

В результате выполнения всех шагов, база данных будет иметь три основные таблицы: `movies`, `genres`, и `movie_genres`. Вот как они будут выглядеть:

### 1. Таблица `movies`

| id | title                                    | release_year |
|----|------------------------------------------|--------------|
| 1  | Миссия невыполнима: Последствия         | 2018         |
| 2  | Человек-паук: Через вселенные           | 2018         |
| 3  | Топ Ган: Маверик                        | 2022         |
| 4  | Джек Ричер                              | 2012         |
| 5  | test                                    | 2000         |
| 6  | Чудо-женщина 1984                       | 2020         |
| 7  | Барби                                   | 2023         |
| 8  | Опенгеймер                              | 2023         |
| 9  | Дюна                                    | 2021         |

### 2. Таблица `genres`

| id | name                     |
|----|--------------------------|
| 1  | Драма                    |
| 2  | Комедия                  |
| 3  | Фантастика               |
| 4  | Боевик                   |
| 5  | Триллер                  |
| 6  | Мелодрама                |
| 7  | Приключения              |
| 8  | Ужасы                    |
| 9  | Документальный           |
| 10 | Анимация                 |
| 11 | Музыкальный              |
| 12 | Исторический             |
| 13 | Фэнтези                  |
| 14 | Семейный                 |
| 15 | Спорт                    |
| 16 | Криминал                 |
| 17 | Романтика                |
| 18 | Научная фантастика       |
| 19 | Супергеройский           |
| 20 | Психологический триллер  |
| 21 | Военный                  |

### 3. Таблица `movie_genre`

| movie_id | genre_id |
|----------|----------|
| 1        | 1        |  -- Миссия невыполнима: Последствия - Драма
| 1        | 4        |  -- Миссия невыполнима: Последствия - Боевик
| 2        | 3        |  -- Человек-паук: Через вселенные - Фантастика
| 2        | 2        |  -- Человек-паук: Через вселенные - Комедия
| 3        | 4        |  -- Топ Ган: Маверик - Боевик
| 3        | 1        |  -- Топ Ган: Маверик - Драма
| 4        | 1        |  -- Джек Ричер - Драма
| 5        | 2        |  -- test - Комедия
| 6        | 3        |  -- Чудо-женщина 1984 - Фантастика
| 6        | 1        |  -- Чудо-женщина 1984 - Драма
| 7        | 2        |  -- Барби - Комедия
| 7        | 3        |  -- Барби - Фантастика
| 8        | 1        |  -- Опенгеймер - Драма
| 8        | 4        |  -- Опенгеймер - Триллер
| 9        | 1        |  -- Дюна - Драма
| 9        | 18       |  -- Дюна - Научная фантастика

### Как это работает

- **Таблица `movies`** содержит информацию о фильмах.
- **Таблица `genres`** содержит список жанров, которые могут быть связаны с фильмами.
- **Таблица `movie_genre`** устанавливает связь между фильмами и их жанрами, позволяя одному фильму принадлежать к нескольким жанрам.